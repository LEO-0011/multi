#!/bin/bash
# setup.sh - YAGAMI UNIVERZE Setup Script

set -e

echo "ðŸ”¥ YAGAMI UNIVERZE Setup Script"
echo "================================"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running as root
if [ "$EUID" -eq 0 ]; then 
    echo -e "${RED}âš ï¸  Please do not run this script as root${NC}"
    exit 1
fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check Docker
echo "ðŸ” Checking Docker..."
if command_exists docker; then
    echo -e "${GREEN}âœ… Docker is installed${NC}"
    docker --version
else
    echo -e "${YELLOW}âš ï¸  Docker is not installed${NC}"
    echo "Installing Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
    echo -e "${GREEN}âœ… Docker installed${NC}"
    echo -e "${YELLOW}âš ï¸  Please log out and log back in for group changes to take effect${NC}"
fi

# Check Docker Compose
echo ""
echo "ðŸ” Checking Docker Compose..."
if command_exists docker-compose; then
    echo -e "${GREEN}âœ… Docker Compose is installed${NC}"
    docker-compose --version
else
    echo -e "${YELLOW}âš ï¸  Docker Compose is not installed${NC}"
    echo "Installing Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    echo -e "${GREEN}âœ… Docker Compose installed${NC}"
fi

# Check Python
echo ""
echo "ðŸ” Checking Python..."
if command_exists python3; then
    echo -e "${GREEN}âœ… Python is installed${NC}"
    python3 --version
else
    echo -e "${RED}âŒ Python 3 is required but not installed${NC}"
    exit 1
fi

# Check Git
echo ""
echo "ðŸ” Checking Git..."
if command_exists git; then
    echo -e "${GREEN}âœ… Git is installed${NC}"
    git --version
else
    echo -e "${YELLOW}âš ï¸  Git is not installed${NC}"
    echo "Installing Git..."
    sudo apt-get update && sudo apt-get install -y git
    echo -e "${GREEN}âœ… Git installed${NC}"
fi

# Create .env if not exists
echo ""
echo "ðŸ“ Setting up environment file..."
if [ ! -f .env ]; then
    cp .env.example .env
    echo -e "${GREEN}âœ… Created .env file from template${NC}"
    echo -e "${YELLOW}âš ï¸  Please edit .env and fill in your credentials${NC}"
    echo ""
    echo "Required variables:"
    echo "  - API_ID (from my.telegram.org)"
    echo "  - API_HASH (from my.telegram.org)"
    echo "  - BOT_TOKEN (from @BotFather)"
    echo "  - ANTHROPIC_API_KEY or OPENAI_API_KEY"
    echo "  - ADMIN_ID (your Telegram user ID)"
    echo ""
    read -p "Press Enter to edit .env now (or Ctrl+C to exit and edit manually)..."
    ${EDITOR:-nano} .env
else
    echo -e "${GREEN}âœ… .env file already exists${NC}"
fi

# Create Docker network
echo ""
echo "ðŸŒ Setting up Docker network..."
if docker network ls | grep -q yagami_network; then
    echo -e "${GREEN}âœ… Docker network already exists${NC}"
else
    docker network create yagami_network
    echo -e "${GREEN}âœ… Docker network created${NC}"
fi

# Create directories
echo ""
echo "ðŸ“ Creating directories..."
mkdir -p logs generated_bots temp
chmod 755 logs generated_bots temp
echo -e "${GREEN}âœ… Directories created${NC}"

# Install Python dependencies (optional, for local development)
echo ""
read -p "Do you want to install Python dependencies for local development? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ“¦ Installing Python dependencies..."
    if command_exists python3-venv; then
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        echo -e "${GREEN}âœ… Python dependencies installed in virtual environment${NC}"
        echo -e "${YELLOW}ðŸ’¡ Activate with: source venv/bin/activate${NC}"
    else
        echo -e "${YELLOW}âš ï¸  python3-venv not found, skipping...${NC}"
    fi
fi

# Final checks
echo ""
echo "ðŸ” Validating .env configuration..."
if [ -f .env ]; then
    missing_vars=()
    required_vars=("API_ID" "API_HASH" "BOT_TOKEN" "ADMIN_ID")
    
    for var in "${required_vars[@]}"; do
        if ! grep -q "^${var}=..*" .env; then
            missing_vars+=("$var")
        fi
    done
    
    if [ ${#missing_vars[@]} -gt 0 ]; then
        echo -e "${RED}âŒ Missing required environment variables:${NC}"
        for var in "${missing_vars[@]}"; do
            echo "   - $var"
        done
        echo ""
        echo -e "${YELLOW}Please edit .env and fill in all required variables${NC}"
    else
        echo -e "${GREEN}âœ… All required variables are set${NC}"
    fi
    
    # Check AI provider
    if ! grep -q "^ANTHROPIC_API_KEY=..*" .env && ! grep -q "^OPENAI_API_KEY=..*" .env; then
        echo -e "${YELLOW}âš ï¸  No AI API key found. Please set either ANTHROPIC_API_KEY or OPENAI_API_KEY${NC}"
    fi
fi

# Summary
echo ""
echo "================================"
echo "ðŸŽ‰ Setup Complete!"
echo "================================"
echo ""
echo "Next steps:"
echo "1. Make sure .env is properly configured"
echo "2. Run: docker-compose up -d"
echo "3. Check logs: docker-compose logs -f"
echo ""
echo "Useful commands:"
echo "  - Start:   docker-compose up -d"
echo "  - Stop:    docker-compose down"
echo "  - Logs:    docker-compose logs -f"
echo "  - Rebuild: docker-compose up --build -d"
echo "  - Status:  docker-compose ps"
echo ""
echo "ðŸ”¥ Happy bot generating!"
echo ""


# ============================================================================
# Makefile
# ============================================================================

.PHONY: help setup build up down restart logs clean test

help:
	@echo "ðŸ”¥ YAGAMI UNIVERZE - Makefile Commands"
	@echo "======================================"
	@echo ""
	@echo "Setup & Deployment:"
	@echo "  make setup     - Run setup script"
	@echo "  make build     - Build Docker image"
	@echo "  make up        - Start bot"
	@echo "  make down      - Stop bot"
	@echo "  make restart   - Restart bot"
	@echo ""
	@echo "Monitoring:"
	@echo "  make logs      - View logs"
	@echo "  make status    - Check status"
	@echo "  make ps        - List containers"
	@echo ""
	@echo "Maintenance:"
	@echo "  make clean     - Clean generated bots and temp files"
	@echo "  make prune     - Prune Docker system"
	@echo "  make backup    - Backup generated bots"
	@echo ""
	@echo "Development:"
	@echo "  make test      - Run tests"
	@echo "  make shell     - Enter container shell"
	@echo "  make local     - Run locally (not in Docker)"
	@echo ""

setup:
	@bash setup.sh

build:
	@echo "ðŸ”¨ Building Docker image..."
	@docker-compose build

up:
	@echo "ðŸš€ Starting YAGAMI UNIVERZE..."
	@docker-compose up -d
	@echo "âœ… Bot started!"
	@echo "ðŸ“Š View logs: make logs"

down:
	@echo "ðŸ›‘ Stopping YAGAMI UNIVERZE..."
	@docker-compose down
	@echo "âœ… Bot stopped!"

restart:
	@echo "ðŸ”„ Restarting YAGAMI UNIVERZE..."
	@docker-compose restart
	@echo "âœ… Bot restarted!"

logs:
	@docker-compose logs -f

status:
	@docker-compose ps
	@echo ""
	@echo "ðŸ“Š Container Stats:"
	@docker stats --no-stream yagami_univerze 2>/dev/null || echo "Container not running"

ps:
	@docker-compose ps

clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -rf temp/*
	@echo "âœ… Temp files cleaned"
	@read -p "Delete generated bots older than 7 days? (y/N) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		find generated_bots/ -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true; \
		echo "âœ… Old generated bots cleaned"; \
	fi

prune:
	@echo "ðŸ§¹ Pruning Docker system..."
	@docker system prune -f
	@echo "âœ… Docker system pruned"

backup:
	@echo "ðŸ’¾ Creating backup..."
	@tar -czf backup_$$(date +%Y%m%d_%H%M%S).tar.gz generated_bots/ .env
	@echo "âœ… Backup created"

test:
	@echo "ðŸ§ª Running tests..."
	@docker-compose exec yagami_univerze pytest tests/ -v

shell:
	@docker-compose exec yagami_univerze /bin/bash

local:
	@echo "ðŸš€ Running locally..."
	@python3 main.py


# ============================================================================
# .gitignore
# ============================================================================

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Virtual Environment
venv/
env/
ENV/
env.bak/
venv.bak/

# Environment
.env
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store

# Logs
logs/
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Database
*.db
*.sqlite
*.sqlite3

# Generated
generated_bots/
temp/
*.zip
*.tar.gz
*.tar

# Docker
*.pid
docker-compose.override.yml

# OS
Thumbs.db
.DS_Store

# Backups
backup_*/
*.backup

# Test
.pytest_cache/
.coverage
htmlcov/
.tox/


# ============================================================================
# LICENSE (MIT)
# ============================================================================

MIT License

Copyright (c) 2024 YAGAMI UNIVERZE

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


# ============================================================================
# CONTRIBUTING.md
# ============================================================================

# Contributing to YAGAMI UNIVERZE

We love your input! We want to make contributing to YAGAMI UNIVERZE as easy and transparent as possible.

## Development Process

1. Fork the repo and create your branch from `main`
2. If you've added code that should be tested, add tests
3. If you've changed APIs, update the documentation
4. Ensure the test suite passes
5. Make sure your code follows the existing style
6. Issue that pull request!

## Code Style

- Follow PEP 8 for Python code
- Use meaningful variable names
- Add docstrings to functions
- Keep functions small and focused
- Write clear commit messages

## Testing

```bash
# Run tests
make test

# Run with coverage
pytest --cov=bot tests/
```

## Pull Request Process

1. Update README.md with details of changes if needed
2. Update requirements.txt if you add dependencies
3. The PR will be merged once you have the sign-off of maintainers

## Bug Reports

Use GitHub issues to report bugs. Include:
- Steps to reproduce
- Expected behavior
- Actual behavior
- Environment details

## Feature Requests

We love feature requests! Open an issue with:
- Clear description of the feature
- Why it would be useful
- Possible implementation approach

Thank you for contributing! ðŸ”¥
